<html>
    <head>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
              integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
              crossorigin=""/>

        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
                integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
                crossorigin=""></script>
        <script src="AnimatedMarker.js"></script>
        <style>
            #map { height: 80%; }
        </style>
    </head>
    <body>
        <h1>CORVIN</h1>
        <div id="map"></div>
        <div id="log"></div>
    </body>
</html>



<script type="text/javascript">

    const optionsNavigator = {
        enableHighAccuracy: true,
        timeout: 1000,
        maximumAge: 0,
    };

    const icon = L.icon({
        iconSize: [50, 50],
        iconUrl:
            "https://images.vexels.com/media/users/3/260938/isolated/lists/fb69cbfbe9d5be3a276c4b5d7f97074e-pa-ssaro-azul-corvo.png",
    });

    const markers = new Map();
    var mapObject;

    function inicializarMapa(lat, lng) {
        mapObject = L.map('map').setView([lat, lng], 13);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(mapObject);
    }

    function addMarker(uuid, lat, lng, nome) {
        if (markers.has(uuid)) {
            markers.get(uuid).setLatLng([lat, lng]).bindPopup(nome);
        } else {
            markers.set(
                uuid,
                L.animatedMarker([[lat, lng]], {icon: icon, autoStart: true})
                    .addTo(mapObject)
                    .bindPopup(nome)
            );
        }
    }

    function inicializarSSE() {
        const evtSource = new EventSource("http://localhost:8080/monitor");

        evtSource.open = (event) => {
            console.log("conectado", event)
        };

        evtSource.onmessage = (event) => {
            // console.log("receive", event.data)
            const crow = JSON.parse(event.data);

            console.log(crow);
            addCrowElement(crow);
            addMarker(crow.uuid, crow.localizacao.latitude, crow.localizacao.longitude, this.getNome(crow))
        };

        evtSource.onerror = (err) => {
            console.error("EventSource failed:", err);
        };
    }

    function getNome(crow) {
        return `<strong>${crow.nome}</strong> ${this.getStatus(crow)}<br/>
                    Restante: ${this.getDistancia(crow.distancia.restante)}<br/>
                    Percorrida: ${this.getDistancia(crow.distancia.percorrida)}`
    }

    function getDistancia(distancia) {

        if (distancia >= 1) {
            return distancia + " km"
        }

        return  distancia * 1000 + " m"
    }


    navigator.geolocation.getCurrentPosition((position) => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        inicializarMapa(lat, lng);
        inicializarSSE();
    }, (erro) => {

        console.log(erro);
        inicializarMapa(-23.4409067, -46.7381877);
        inicializarSSE();

    }, optionsNavigator);


    function addCrowElement(crow) {
        var element = document.getElementById(crow.uuid);
        if (!element) {
            element = document.createElement("div")
            element.setAttribute("id", crow.uuid);
            const map = document.getElementById("log");
            map.appendChild(element);
        }

        element.innerText = ''

        const lat = document.createElement("span");
        lat.innerText = crow.localizacao.latitude + " - " ;

        const long = document.createElement("span");
        long.innerText = crow.localizacao.longitude + " - ";

        const nome = document.createElement("span");
        nome.innerText = crow.nome;

        const status = document.createElement("span");
        status.innerText = " - " + this.getStatus(crow);

        element.appendChild(lat);
        element.appendChild(long);
        element.appendChild(nome);
        element.append(status);

    }

    function getStatus(crow) {
        if (crow.chegou) {
            return "CHEGOU";
        } else if (crow.pouso) {
            return "POUSANDO";
        } else if (crow.iniciandoVoo) {
            return "INICIANDO VOO"
        }

        return "VOANDO";
    }
</script>